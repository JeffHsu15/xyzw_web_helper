import"./index-CHhX6Zfi.js";const T=t=>{var i,c,m,o,r;if(!t)return null;if(Array.isArray(t)){const n=t[0];return(n==null?void 0:n.roleId)||(n==null?void 0:n.id)||(n==null?void 0:n.targetId)}const e=((i=t==null?void 0:t.rankList)==null?void 0:i[0])||((c=t==null?void 0:t.roleList)==null?void 0:c[0])||((m=t==null?void 0:t.targets)==null?void 0:m[0])||((o=t==null?void 0:t.targetList)==null?void 0:o[0])||((r=t==null?void 0:t.list)==null?void 0:r[0]);if(e){if(e.roleId)return e.roleId;if(e.id)return e.id;if(e.targetId)return e.targetId}return(t==null?void 0:t.roleId)||(t==null?void 0:t.id)||(t==null?void 0:t.targetId)},f=t=>{if(!t)return!0;const e=new Date().toDateString(),i=new Date(t*1e3).toDateString();return e!==i},D=()=>{const t=[9904,9905,9901,9902,9903,9904,9905],e=new Date().getDay();return t[e]};class O{constructor(e,i=null){this.tokenStore=e,this.delaySettings=i||{commandDelay:500,taskDelay:500}}log(e,i="info"){var c;(c=this.callbacks)!=null&&c.onLog&&this.callbacks.onLog({time:new Date().toLocaleTimeString(),message:e,type:i})}async executeGameCommand(e,i,c={},m="",o=8e3){try{m&&this.log(`执行: ${m}`);const r=await this.tokenStore.sendMessageWithPromise(e,i,c,o);return await new Promise(n=>setTimeout(n,this.delaySettings.commandDelay)),m&&this.log(`${m} - 成功`,"success"),r}catch(r){if(m){const n=this.tokenStore.gameTokens.find(x=>x.id===e),h=(n==null?void 0:n.name)||e;this.log(`[${h}] ${m} - 失败: ${r.message}`,"error")}throw r}}async switchToFormationIfNeeded(e,i,c){var m;try{this.log(`检查${c}配置...`);const o=await this.executeGameCommand(e,"presetteam_getinfo",{},"获取阵容信息");(!o||!o.presetTeamInfo)&&this.log(`阵容信息异常: ${JSON.stringify(o)}`,"warning");const r=(m=o==null?void 0:o.presetTeamInfo)==null?void 0:m.useTeamId;return this.log(`当前阵容: ${r}`),r===i?(this.log(`当前已是${c}${i}，无需切换`,"success"),!1):(this.log(`当前阵容: ${r}, 目标阵容: ${i}，开始切换...`),await this.executeGameCommand(e,"presetteam_saveteam",{teamId:i},`切换到${c}${i}`),this.log(`成功切换到${c}${i}`,"success"),!0)}catch(o){this.log(`阵容检查失败，尝试强制切换: ${o.message}`,"warning");try{return await this.executeGameCommand(e,"presetteam_saveteam",{teamId:i},`强制切换到${c}${i}`),!0}catch(r){throw this.log(`强制切换也失败: ${r.message}`,"error"),r}}}loadSettings(e){try{const i=localStorage.getItem(`daily-settings:${e}`),c={arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0};return i?{...c,...JSON.parse(i)}:c}catch(i){return console.error("Failed to load settings:",i),null}}async run(e,i={},c=null){var _,S,C;this.callbacks=i;const m=c||this.loadSettings(e);this.log("正在获取角色信息...");let o;try{o=await this.tokenStore.sendGetRoleInfo(e),this.log("角色信息获取成功","success")}catch(a){throw this.log(`获取角色信息失败: ${a.message}`,"error"),a}const r=o==null?void 0:o.role;if(!r)throw new Error("角色数据不存在");this.log("开始执行每日任务补差");const n=((_=r.dailyTask)==null?void 0:_.complete)??{},h=a=>n[a]===-1,x=r.statistics??{},p=r.statisticsTime??{},s=[];if(h(2)||s.push({name:"分享一次游戏",execute:()=>this.executeGameCommand(e,"system_mysharecallback",{isSkipShareCard:!0,type:2},"分享游戏")}),h(3)||s.push({name:"赠送好友金币",execute:()=>this.executeGameCommand(e,"friend_batch",{},"赠送好友金币")}),h(4)||(s.push({name:"免费招募",execute:()=>this.executeGameCommand(e,"hero_recruit",{recruitType:3,recruitNumber:1},"免费招募")}),m.payRecruit&&s.push({name:"付费招募",execute:()=>this.executeGameCommand(e,"hero_recruit",{recruitType:1,recruitNumber:1},"付费招募")})),!h(6)&&f(p["buy:gold"]))for(let a=0;a<3;a++)s.push({name:`免费点金 ${a+1}/3`,execute:()=>this.executeGameCommand(e,"system_buygold",{buyNum:1},`免费点金 ${a+1}`)});if(!h(5)&&m.claimHangUp){s.push({name:"领取挂机奖励",execute:()=>this.executeGameCommand(e,"system_claimhangupreward",{},"领取挂机奖励")});for(let a=0;a<4;a++)s.push({name:`挂机加钟 ${a+1}/4`,execute:()=>this.executeGameCommand(e,"system_mysharecallback",{isSkipShareCard:!0,type:2},`挂机加钟 ${a+1}`)})}if(!h(7)&&m.openBox&&s.push({name:"开启木质宝箱",execute:()=>this.executeGameCommand(e,"item_openbox",{itemId:2001,number:10},"开启木质宝箱10个")}),s.push({name:"停止盐罐计时",execute:()=>this.executeGameCommand(e,"bottlehelper_stop",{},"停止盐罐计时")}),s.push({name:"开始盐罐计时",execute:()=>this.executeGameCommand(e,"bottlehelper_start",{},"开始盐罐计时")}),!h(14)&&m.claimBottle&&s.push({name:"领取盐罐奖励",execute:()=>this.executeGameCommand(e,"bottlehelper_claim",{},"领取盐罐奖励")}),!h(13)&&m.arenaEnable&&s.push({name:"竞技场战斗",execute:async()=>{this.log("开始竞技场战斗流程");const a=new Date().getHours();if(a<6){this.log("当前时间未到6点，跳过竞技场战斗","warning");return}if(a>22){this.log("当前时间已过22点，跳过竞技场战斗","warning");return}await this.switchToFormationIfNeeded(e,m.arenaFormation,"竞技场阵容"),await this.executeGameCommand(e,"arena_startarea",{},"开始竞技场");for(let l=1;l<=3;l++){this.log(`竞技场战斗 ${l}/3`);let u;try{u=await this.executeGameCommand(e,"arena_getareatarget",{},`获取竞技场目标${l}`)}catch(g){this.log(`竞技场战斗${l} - 获取对手失败: ${g.message}`,"error");break}const y=T(u);y?await this.executeGameCommand(e,"fight_startareaarena",{targetId:y},`竞技场战斗${l}`,1e4):this.log(`竞技场战斗${l} - 未找到目标: ${JSON.stringify(u)}`,"warning"),await new Promise(g=>setTimeout(g,1e3))}}}),m.bossTimes>0){let a=x["legion:boss"]??0;f(p["legion:boss"])&&(a=0);const l=Math.max(m.bossTimes-a,0);if(l>0){s.push({name:"军团BOSS阵容检查",execute:()=>this.switchToFormationIfNeeded(e,m.bossFormation,"BOSS阵容")});for(let u=0;u<l;u++)s.push({name:`军团BOSS ${u+1}/${l}`,execute:()=>this.executeGameCommand(e,"fight_startlegionboss",{},`军团BOSS ${u+1}`,12e3)})}}const G=D();s.push({name:"每日BOSS阵容检查",execute:()=>this.switchToFormationIfNeeded(e,m.bossFormation,"BOSS阵容")});for(let a=0;a<3;a++)s.push({name:`每日BOSS ${a+1}/3`,execute:()=>this.executeGameCommand(e,"fight_startboss",{bossId:G},`每日BOSS ${a+1}`,12e3)});const w=[{name:"福利签到",cmd:"system_signinreward"},{name:"俱乐部",cmd:"legion_signin"},{name:"领取每日礼包",cmd:"discount_claimreward"},{name:"领取每日免费奖励",cmd:"collection_claimfreereward"},{name:"领取免费礼包",cmd:"card_claimreward"},{name:"领取永久卡礼包",cmd:"card_claimreward",params:{cardId:4003}}];if(m.claimEmail&&w.push({name:"领取邮件奖励",cmd:"mail_claimallattachment"}),w.forEach(a=>{s.push({name:a.name,execute:()=>this.executeGameCommand(e,a.cmd,a.params||{},a.name)})}),s.push({name:"开始领取珍宝阁礼包",execute:()=>this.executeGameCommand(e,"collection_goodslist",{},"开始领取珍宝阁礼包")}),s.push({name:"领取珍宝阁免费礼包",execute:()=>this.executeGameCommand(e,"collection_claimfreereward",{},"领取珍宝阁免费礼包")}),f(x["artifact:normal:lottery:time"]))for(let a=0;a<3;a++)s.push({name:`免费钓鱼 ${a+1}/3`,execute:()=>this.executeGameCommand(e,"artifact_lottery",{lotteryNumber:1,newFree:!0,type:1},`免费钓鱼 ${a+1}`)});const $=["魏国","蜀国","吴国","群雄"];for(let a=1;a<=4;a++)f(p[`genie:daily:free:${a}`])&&s.push({name:`${$[a-1]}灯神免费扫荡`,execute:()=>this.executeGameCommand(e,"genie_sweep",{genieId:a},`${$[a-1]}灯神免费扫荡`)});for(let a=0;a<3;a++)s.push({name:`领取免费扫荡卷 ${a+1}/3`,execute:()=>this.executeGameCommand(e,"genie_buysweep",{},`领取免费扫荡卷 ${a+1}`)});!h(12)&&m.blackMarketPurchase&&s.push({name:"黑市购买1次物品",execute:()=>this.executeGameCommand(e,"store_purchase",{goodsId:1},"黑市购买1次物品")});const d=new Date().getDay();if(d===0|d===1|d===3|d===4){const a={0:107};s.push({name:"咸王梦境",execute:()=>this.executeGameCommand(e,"dungeon_selecthero",{battleTeam:a},"咸王梦境")})}d===1&&f(p["genie:daily:free:5"])&&s.push({name:"深海灯神",execute:()=>this.executeGameCommand(e,"genie_sweep",{genieId:5,sweepCnt:1},"深海灯神")});for(let a=1;a<=10;a++)s.push({name:`领取任务奖励${a}`,execute:()=>this.executeGameCommand(e,"task_claimdailypoint",{taskId:a},`领取任务奖励${a}`,5e3)});s.push({name:"领取日常任务奖励",execute:()=>this.executeGameCommand(e,"task_claimdailyreward",{},"领取日常任务奖励")},{name:"领取周常任务奖励",execute:()=>this.executeGameCommand(e,"task_claimweekreward",{},"领取周常任务奖励")},{name:"领取通行证奖励",execute:()=>this.executeGameCommand(e,"activity_recyclewarorderrewardclaim",{actId:1},"领取通行证奖励")});const b=s.length;this.log(`共有 ${b} 个任务待执行`);for(let a=0;a<s.length;a++){const l=s[a];try{await l.execute();const u=Math.floor((a+1)/b*100);(S=this.callbacks)!=null&&S.onProgress&&this.callbacks.onProgress(u),await new Promise(y=>setTimeout(y,this.delaySettings.taskDelay))}catch(u){this.log(`任务执行失败: ${l.name} - ${u.message}`,"error")}}(C=this.callbacks)!=null&&C.onProgress&&this.callbacks.onProgress(100),this.log("所有任务执行完成","success")}}export{O as D};
